ARG TRAEFIK_VERSION
FROM traefik:${TRAEFIK_VERSION} as base

ARG CLOUDFLARE_DNS_API_TOKEN
ENV CLOUDFLARE_DNS_API_TOKEN=${CLOUDFLARE_DNS_API_TOKEN}

RUN apk --no-cache add \
    sed \
    tzdata \
    perl-mime-base64

# Timezone
ARG TIMEZONE
ENV TZ=${TIMEZONE}
RUN ln -snf /usr/share/zoneinfo/$TIMEZONE /etc/localtime && echo $TIMEZONE > /etc/timezone

# COPY ./images/traefik/traefik.yml /etc/traefik/traefik.yml
# COPY ./images/traefik/conf/dynamic.yml /etc/traefik/conf/dynamic.yml

ARG TRAEFIK_LOG_LEVEL
ARG TRAEFIK_API_DASHBOARD
ARG TRAEFIK_API_INSECURE
ARG TRAEFIK_DOMAIN_NAME
ARG TRAEFIK_DOCKER_NETWORK
ARG TRAEFIK_DOCKER_ENTRYPOINT
ARG TRAEFIK_ACME_EMAIL_ADDRESS
ARG TRAEFIK_ACME_DNS_CHALLENGE_PROVIDER
ENV TRAEFIK_LOG_LEVEL ${TRAEFIK_LOG_LEVEL}
ENV TRAEFIK_API_DASHBOARD ${TRAEFIK_API_DASHBOARD}
ENV TRAEFIK_API_INSECURE ${TRAEFIK_API_INSECURE}
ENV TRAEFIK_DOMAIN_NAME ${TRAEFIK_DOMAIN_NAME}
ENV TRAEFIK_DOCKER_NETWORK ${TRAEFIK_DOCKER_NETWORK}
ENV TRAEFIK_DOCKER_ENTRYPOINT ${TRAEFIK_DOCKER_ENTRYPOINT}
ENV TRAEFIK_ACME_EMAIL_ADDRESS ${TRAEFIK_ACME_EMAIL_ADDRESS}
ENV TRAEFIK_ACME_DNS_CHALLENGE_PROVIDER ${TRAEFIK_ACME_DNS_CHALLENGE_PROVIDER}

# ARG TRAEFIK_BASIC_AUTH_USERNAME
# ARG TRAEFIK_BASIC_AUTH_PASSWORD_HASH
# # Modify dynamic config
# RUN sed -i /etc/traefik/conf/dynamic.yml \
#     -e "s#__TRAEFIK_BASIC_AUTH_USERNAME#$TRAEFIK_BASIC_AUTH_USERNAME#g" \
#     -e "s#__TRAEFIK_BASIC_AUTH_PASSWORD_HASH#$TRAEFIK_BASIC_AUTH_PASSWORD_HASH#g";
COPY ./images/traefik/setup.sh /
RUN chmod a+x /setup.sh

ENTRYPOINT [ "/setup.sh" ]

CMD [ "traefik" ]

FROM base as local