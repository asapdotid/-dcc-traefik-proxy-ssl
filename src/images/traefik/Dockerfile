ARG TRAEFIK_VERSION
FROM traefik:${TRAEFIK_VERSION} as base

ARG CLOUDFLARE_DNS_API_TOKEN
ENV CLOUDFLARE_DNS_API_TOKEN=${CLOUDFLARE_DNS_API_TOKEN}

RUN apk --no-cache add \
    sed \
    tzdata \
    openssl \
    perl-mime-base64

# Timezone
ARG TIMEZONE
ENV TZ=${TIMEZONE}
RUN ln -snf /usr/share/zoneinfo/$TIMEZONE /etc/localtime && echo $TIMEZONE > /etc/timezone

# Traefik config
ARG TRAEFIK_LOG_LEVEL
ARG TRAEFIK_DOMAIN_NAME
ARG TRAEFIK_DOCKER_NETWORK
ARG TRAEFIK_DOCKER_ENTRYPOINT
ARG TRAEFIK_ACME_EMAIL_ADDRESS
ARG TRAEFIK_ACME_DNS_CHALLENGE_PROVIDER
ARG TRAEFIK_API_DASHBOARD
ARG TRAEFIK_API_DASHBOARD_SUBDOMAIN
ARG TRAEFIK_API_INSECURE
ENV TRAEFIK_LOG_LEVEL ${TRAEFIK_LOG_LEVEL}
ENV TRAEFIK_DOMAIN_NAME ${TRAEFIK_DOMAIN_NAME}
ENV TRAEFIK_DOCKER_NETWORK ${TRAEFIK_DOCKER_NETWORK}
ENV TRAEFIK_DOCKER_ENTRYPOINT ${TRAEFIK_DOCKER_ENTRYPOINT}
ENV TRAEFIK_ACME_EMAIL_ADDRESS ${TRAEFIK_ACME_EMAIL_ADDRESS}
ENV TRAEFIK_ACME_DNS_CHALLENGE_PROVIDER ${TRAEFIK_ACME_DNS_CHALLENGE_PROVIDER}
ENV TRAEFIK_API_DASHBOARD ${TRAEFIK_API_DASHBOARD}
ENV TRAEFIK_API_DASHBOARD_SUBDOMAIN ${TRAEFIK_API_DASHBOARD_SUBDOMAIN}
ENV TRAEFIK_API_INSECURE ${TRAEFIK_API_INSECURE}
# Basic Auth
ARG TRAEFIK_BASIC_AUTH_USERNAME
ARG TRAEFIK_BASIC_AUTH_PASSWORD_HASH
ENV TRAEFIK_BASIC_AUTH_USERNAME ${TRAEFIK_BASIC_AUTH_USERNAME}
ENV TRAEFIK_BASIC_AUTH_PASSWORD_HASH ${TRAEFIK_BASIC_AUTH_PASSWORD_HASH}
# Middleware Header
ARG TRAEFIK_HEADER_X_ROBOTS_TAG
ARG TRAEFIK_HEADER_REFERRER_POLICY
ARG TRAEFIK_HEADER_FRAME_DENY
ARG TRAEFIK_HEADER_CONTENT_SECURITY_POLICY
ARG TRAEFIK_HEADER_PERMISSION_POLICY
ARG TEAEFIK_HEADER_CORS_LIST
ENV TRAEFIK_HEADER_X_ROBOTS_TAG ${TRAEFIK_HEADER_X_ROBOTS_TAG}
ENV TRAEFIK_HEADER_REFERRER_POLICY ${TRAEFIK_HEADER_REFERRER_POLICY}
ENV TRAEFIK_HEADER_FRAME_DENY ${TRAEFIK_HEADER_FRAME_DENY}
ENV TRAEFIK_HEADER_CONTENT_SECURITY_POLICY ${TRAEFIK_HEADER_CONTENT_SECURITY_POLICY}
ENV TRAEFIK_HEADER_PERMISSION_POLICY ${TRAEFIK_HEADER_PERMISSION_POLICY}
ENV TEAEFIK_HEADER_CORS_LIST ${TEAEFIK_HEADER_CORS_LIST}

COPY ./images/traefik/config/traefik.yml /etc/traefik/traefik.yml
COPY ./images/traefik/config/dynamic/ /etc/traefik/dynamic/

COPY ./images/traefik/setup.sh /
RUN chmod a+x /setup.sh

ENTRYPOINT [ "/setup.sh" ]

CMD [ "traefik" ]

FROM base as local
